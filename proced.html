<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Procedimentos</title>
  <style>
    body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f0f4f8;
  color: #333;
  padding: 30px;
  margin: 0;
}

h1 {
  color: #166;
  font-size: 28px;
  margin-bottom: 20px;
  border-bottom: 2px solid #166;
  padding-bottom: 5px;
}

input, select {
  padding: 10px 12px;
  font-size: 16px;
  margin-bottom: 20px;
  width: 100%;
  max-width: 400px;
  border: 1px solid #ccc;
  border-radius: 6px;
  transition: border 0.3s ease;
}

input:focus, select:focus {
  border-color: #166;
  outline: none;
}

#status {
  margin: 15px 0;
  color: #666;
  font-size: 14px;
}

#resultados {
  margin-top: 20px;
}

.resultado {
  background-color: #fff;
  border-left: 5px solid #166;
  border-radius: 5px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  padding: 15px 20px;
  margin-bottom: 15px;
  transition: background 0.2s ease;
}

.resultado:hover {
  background-color: #f9f9f9;
}

.codigo {
  font-weight: bold;
  font-size: 18px;
  color: #166;
  margin-bottom: 5px;
}

.nome {
  font-size: 16px;
  margin-bottom: 5px;
  color: #333;
}

.valor {
  font-size: 15px;
  font-weight: bold;
  color: #2e7d32;
}

  </style>
</head>
<body>

  <h1>Consulta de Procedimentos</h1>

  <label for="prefixoFiltro">Filtrar código por início:</label><br>
  <select id="prefixoFiltro">
    <option value="">Todos os códigos</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
  </select>

  <br><br>

  <input type="text" id="buscaInput" placeholder="Digite o nome do procedimento...">
  <div id="status">Carregando procedimentos...</div>
  <div id="resultados"></div>

  <script>
    const buscaInput = document.getElementById('buscaInput');
    const divResultados = document.getElementById('resultados');
    const divStatus = document.getElementById('status');
    const filtroPrefixo = document.getElementById('prefixoFiltro');

    let procedimentos = [];

    function formatarReais(valor) {
      return valor !== null && !isNaN(valor)
        ? `R$ ${Number(valor).toFixed(2).replace('.', ',')}`
        : 'Valor indisponível';
    }

    // Parser para procedimentos.txt (CSV com 4 campos entre aspas)
    function parseProcedimentosTxt1(raw) {
      const linhas = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      return linhas.map(linha => {
        const partes = linha.split('","').map(p => p.replace(/(^"|"$)/g, ''));
        if (partes.length !== 4) {
          console.warn('Linha inválida no procedimentos.txt:', linha);
          return null;
        }
        const valor = parseFloat(partes[3].replace(',', '.'));
        return {
          codigo: partes[0],
          nome: partes[2],
          valor: isNaN(valor) ? 0 : valor
        };
      }).filter(Boolean);
    }

    // Parser para procedi.txt (linha com código, nome e dois valores no final)
    function parseProcedimentosTxt2(raw) {
      const linhas = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      return linhas.map(linha => {
        linha = linha.replace(/^"|"$/g, '');
        const regex = /^(\d+)\s+(.*?)\s+([\d,.]+)\s+([\d,.]+)$/;
        const match = linha.match(regex);
        if (!match) {
          console.warn('Linha inválida no procedi.txt:', linha);
          return null;
        }
        const codigo = match[1];
        const nome = match[2].trim();
        const valor = parseFloat(match[4].replace(',', '.'));
        return {
          codigo,
          nome,
          valor: isNaN(valor) ? 0 : valor
        };
      }).filter(Boolean);
    }

    function mostrarResultados(termo) {
      const prefixo = filtroPrefixo.value;
      divResultados.innerHTML = '';

      const filtro = procedimentos.filter(p => {
        const condTermo = p.nome.toLowerCase().includes(termo.toLowerCase());
        // verifica se o código começa com "0" + prefixo ou só prefixo
        const condPrefixo = prefixo
          ? p.codigo.startsWith('0' + prefixo) || p.codigo.startsWith(prefixo)
          : true;
        return condTermo && condPrefixo;
      });

      if (filtro.length === 0) {
        divResultados.innerHTML = '<p>Nenhum procedimento encontrado.</p>';
        return;
      }

      filtro.forEach(p => {
        const div = document.createElement('div');
        div.className = 'resultado';
        div.innerHTML = `
          <div class="codigo">${p.codigo}</div>
          <div class="nome">${p.nome}</div>
          <div class="valor">Valor: ${formatarReais(p.valor)}</div>
        `;
        divResultados.appendChild(div);
      });
    }

    // Carrega os arquivos txt (coloque os dois .txt na mesma pasta do seu HTML)
    Promise.all([
      fetch('procedimentos.txt').then(r => r.text()),
      fetch('procedi.txt').then(r => r.text())
    ])
    .then(([texto1, texto2]) => {
      const lista1 = parseProcedimentosTxt1(texto1);
      const lista2 = parseProcedimentosTxt2(texto2);
      procedimentos = [...lista1, ...lista2];
      divStatus.textContent = `Carregado. Total: ${procedimentos.length} procedimentos.`;
      mostrarResultados('');
    })
    .catch(err => {
      divStatus.textContent = 'Erro ao carregar: ' + err.message;
    });

    buscaInput.addEventListener('input', () => {
      mostrarResultados(buscaInput.value);
    });

    filtroPrefixo.addEventListener('change', () => {
      mostrarResultados(buscaInput.value);
    });
  </script>
</body>
</html>
