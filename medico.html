<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Busca CID + Procedimentos</title>
<style>
  /* Fundo com imagem 1.gif */
  body {
    font-family: Arial, sans-serif;
    margin: 0; /* Removido margin para topo fixo */
    background: url('1.gif') no-repeat center center fixed;
    background-size: cover;
    color: #222;
  }

  /* Camada semitransparente para melhorar leitura */
  body::before {
    content: "";
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(255,255,255,0.85);
    z-index: -1;
  }

  /* Topo fixo */
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 60px;
    background-color: #166;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-sizing: border-box;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    z-index: 20;
  }

  header img {
    height: 40px;
    object-fit: contain;
  }

  header h1 {
    color: white;
    font-size: 20px;
    margin: 0;
    text-align: center;
    flex-grow: 1;
    user-select: none;
  }

  /* Conteúdo abaixo do topo */
  main {
    padding: 100px 20px 20px 20px; /* Espaço para o topo fixo */
    max-width: 900px;
    margin: 0 auto;
  }

  input[type="text"] {
    padding: 10px;
    width: 300px;
    font-size: 16px;
    border: 2px solid #166;
    border-radius: 5px;
    outline-offset: 2px;
    transition: outline-offset 0.2s;
  }

  input[type="text"]:focus {
    outline: 2px solid #166;
    outline-offset: 4px;
  }

  button.pesquisar {
    background-color: #166;
    color: white;
    border: none;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 8px;
    transition: background-color 0.3s;
  }

  button.pesquisar:hover {
    background-color: #0d3a0d;
  }

  .cid-item {
    margin-bottom: 25px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 15px;
  }

  .cid-item strong {
    color: #166;
  }

  pre {
    background: #f0f0f0;
    padding: 12px;
    border-radius: 6px;
    white-space: pre-wrap;
    font-family: Consolas, monospace;
    color: #333;
  }
</style>
</head>
<body>

<header>
  <img src="https://alphainstituto.com.br/wp-content/uploads/2019/03/cropped-logo2-1.jpg" alt="Logo 1" />
  <h1>Hospital de Clínicas Anjo Gabriel</h1>
  <img src="https://www.mairiporaeducasim.com.br/assets/img/prefeitura-mairipora.png" alt="Logo 2" />
</header>

<main>
  <input type="text" id="searchInput" placeholder="Digite código ou nome do CID" />
  <button class="pesquisar" onclick="buscar()">Pesquisar</button>

  <div id="result"></div>
</main>

<script>
let capitulos = [];
let grupos = [];
let categorias = {};
let subcategorias = [];
let procedimentos = [];

// Função para carregar JSON via fetch
async function carregarJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error('Erro ao carregar ' + url);
  return res.json();
}

// Carregar todos os JSONs e armazenar em variáveis
async function carregarDados() {
  try {
    capitulos = await carregarJSON('cid-10-capitulos.json');
    grupos = await carregarJSON('cid-10-grupos.json');
    const categoriasArray = await carregarJSON('cid-10-categorias.json');
    subcategorias = await carregarJSON('cid-10-subcategorias.json');
    procedimentos = await carregarJSON('cid.json'); 

    categoriasArray.forEach(c => {
      categorias[c.CAT] = c.DESCRICAO || c.DESCRABREV || '';
    });

  } catch (e) {
    document.getElementById('result').textContent = 'Erro ao carregar dados: ' + e.message;
  }
}

// Função que associa um código CID com procedimentos
function getProcedimentosPorCID(cidCodigo) {
  const prefixo = cidCodigo.replace('.', '').slice(0, 4); 

  const encontrados = procedimentos.filter(proc => {
    const texto = proc["ESTADO DA BAHIA"];
    if (!texto) return false;
    const codigoProc = texto.trim().split(/\s+/)[0];
    return codigoProc.startsWith(prefixo);
  });

  return encontrados;
}

function formatarProcedimentos(procArray) {
  if (procArray.length === 0) return 'Nenhum procedimento encontrado.';

  return procArray.map(p => {
    const texto = p["ESTADO DA BAHIA"];
    const partes = texto.trim().split(/\s{2,}/); 
    return partes[0] + ' ' + (partes[1] || '');
  }).join('\n');
}

function buscar() {
  const termo = document.getElementById('searchInput').value.trim().toLowerCase();
  const resultadoDiv = document.getElementById('result');
  resultadoDiv.innerHTML = '';

  if (!termo) {
    resultadoDiv.textContent = 'Digite um código ou nome para pesquisar.';
    return;
  }

  const encontrados = subcategorias.filter(cid => {
    const codigo = cid.SUBCAT || '';
    const nome = (cid.DESCRICAO || cid.DESCRABREV || '').toLowerCase();
    return codigo.toLowerCase().includes(termo) || nome.includes(termo);
  });

  if (encontrados.length === 0) {
    resultadoDiv.textContent = 'Nenhum CID encontrado.';
    return;
  }

  encontrados.forEach(cid => {
    const codigo = cid.SUBCAT || '';
    const nome = cid.DESCRICAO || cid.DESCRABREV || '(sem descrição)';

    const procs = getProcedimentosPorCID(codigo);
    const procsFormatados = formatarProcedimentos(procs);

    const capituloTexto = capitulos.find(cap => {
      const catIni = cap.CATINIC || cap.CATINIC?.toUpperCase();
      const catFim = cap.CATFIM || cap.CATFIM?.toUpperCase();
      return codigo >= catIni && codigo <= catFim;
    })?.DESCRABREV || 'Capítulo desconhecido';

    const grupoTexto = grupos.find(g => {
      const catIni = g.CATINIC || g.CATINIC?.toUpperCase();
      const catFim = g.CATFIM || g.CATFIM?.toUpperCase();
      return codigo >= catIni && codigo <= catFim;
    })?.DESCRABREV || '';

    const categoriaCodigo = codigo.slice(0, 3);
    const categoriaNome = categorias[categoriaCodigo] || '';

    resultadoDiv.innerHTML += `
      <div class="cid-item">
        <strong>${capituloTexto}</strong><br>
        <em>${grupoTexto}</em><br>
        <strong>Categoria:</strong> ${categoriaCodigo} - ${categoriaNome}<br>
        <strong>CID:</strong> ${codigo} - ${nome.replace(/\s+/g,' ')}<br>
        <pre>
Procedimentos:
${procsFormatados}
        </pre>
      </div>
    `;
  });
}

window.onload = carregarDados;
</script>

</body>
</html>
